<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>LM PayTrack</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      min-height: 100vh;
      line-height: 1.5;
    }

    h1, h2, h3 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    .header {
      background: #000000;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header button {
      background: transparent;
      color: white;
      border: 1px solid #444;
      padding: 6px 14px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 0.3s;
    }

    .header button:hover {
      background: #ffffff;
      color: #000000;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .container.wide {
      max-width: 900px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: #0a0a0a;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 57px;
      z-index: 99;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: #666;
      font-family: 'Montserrat', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
    }

    .tab-btn:hover {
      color: #aaa;
    }

    .tab-btn.active {
      color: #fff;
      border-bottom-color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Review Table Styles */
    .review-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .review-table th {
      background: #1a1a1a;
      color: #888;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .review-table th.right {
      text-align: right;
    }

    .review-table td {
      padding: 14px 8px;
      border-bottom: 1px solid #222;
      color: #ccc;
    }

    .review-table td.right {
      text-align: right;
    }

    .review-table tr:hover {
      background: #151515;
    }

    .review-table tfoot td {
      background: #1a2a1a;
      border-top: 2px solid #2a4a2a;
      font-weight: 600;
      color: #fff;
    }

    .review-table tfoot td.total-value {
      color: #6bff6b;
      font-size: 14px;
    }

    .review-table .cash-tips {
      color: #ff6b6b;
    }

    .no-entries {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .btn-delete-small {
      background: #8b0000;
      color: white;
      border: none;
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      transition: background 0.2s;
    }

    .btn-delete-small:hover {
      background: #a00000;
    }

    .login-box {
      max-width: 380px;
      margin: 60px auto;
      background: #111111;
      padding: 40px 32px;
      border: 1px solid #333;
    }

    .login-box h2 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 28px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .login-subtitle {
      text-align: center;
      color: #666;
      font-size: 12px;
      margin-bottom: 32px;
      letter-spacing: 0.1em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #888;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #333;
      background: #0a0a0a;
      color: #ffffff;
      font-size: 16px;
      font-family: 'Montserrat', sans-serif;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #ffffff;
    }

    input::placeholder {
      color: #444;
    }

    button {
      padding: 14px 28px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Montserrat', sans-serif;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .btn-primary {
      background: #ffffff;
      color: #000000;
      width: 100%;
    }

    .btn-primary:hover {
      background: #e0e0e0;
    }

    .btn-primary:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }

    .btn-secondary:hover {
      background: #333;
    }

    .btn-danger {
      background: #8b0000;
      color: white;
    }

    .btn-danger:hover {
      background: #a00000;
    }

    .btn-success {
      background: #1a472a;
      color: white;
    }

    .btn-success:hover {
      background: #1e5631;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 10px;
    }

    .alert {
      padding: 14px 18px;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 13px;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.error {
      background: #2a1010;
      color: #ff6b6b;
      border: 1px solid #8b0000;
    }

    .alert.success {
      background: #102a10;
      color: #6bff6b;
      border: 1px solid #006600;
    }

    .card {
      background: #111111;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }

    .card h3 {
      margin-bottom: 20px;
      color: #ffffff;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Date Picker Styles */
    .date-picker-container {
      background: #111;
      border: 1px solid #333;
      padding: 20px;
      margin-bottom: 20px;
    }

    .date-display {
      text-align: center;
      padding: 16px;
      background: #0a0a0a;
      border: 1px solid #333;
      margin-bottom: 16px;
    }

    .date-display .day-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 14px;
      color: #888;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .date-display .full-date {
      font-family: 'Cormorant Garamond', serif;
      font-size: 24px;
      color: #fff;
      letter-spacing: 0.05em;
    }

    .date-scroll-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-scroll-btn {
      background: #222;
      border: 1px solid #ffffff;
      color: #fff;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .date-scroll-btn:hover {
      background: #333;
    }

    .date-scroll-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .date-wheel {
      flex: 1;
      height: 120px;
      overflow: hidden;
      position: relative;
      background: #0a0a0a;
      border: 1px solid #ffffff;
    }

    .date-wheel-inner {
      position: absolute;
      width: 100%;
      transition: transform 0.3s ease;
    }

    .date-wheel-item {
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #555;
      cursor: pointer;
      transition: all 0.2s;
    }

    .date-wheel-item.selected {
      color: #fff;
      font-weight: 600;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
    }

    .date-wheel-item.future {
      color: #333;
      cursor: not-allowed;
    }

    .date-wheel::before,
    .date-wheel::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      height: 40px;
      pointer-events: none;
      z-index: 2;
    }

    .date-wheel::before {
      top: 0;
      background: linear-gradient(to bottom, #0a0a0a, transparent);
    }

    .date-wheel::after {
      bottom: 0;
      background: linear-gradient(to top, #0a0a0a, transparent);
    }

    /* Time inputs */
    .time-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .time-row.three-col {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .calculated-hours {
      background: #1a2a1a;
      border: 1px solid #2a4a2a;
      padding: 16px;
      text-align: center;
      margin-bottom: 20px;
    }

    .calculated-hours .label {
      font-size: 10px;
      color: #6bff6b;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .calculated-hours .value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 32px;
      color: #fff;
    }

    /* Service entries */
    .service-entries {
      margin-top: 24px;
      border-top: 1px solid #333;
      padding-top: 24px;
    }

    .service-entry {
      background: #0a0a0a;
      border: 1px solid #333;
      padding: 16px;
      margin-bottom: 12px;
    }

    .service-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .service-entry-title {
      font-size: 12px;
      color: #888;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .remove-entry {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 18px;
    }

    .remove-entry:hover {
      color: #ff6b6b;
    }

    .service-entry .form-group {
      margin-bottom: 12px;
    }

    .service-entry .form-group:last-child {
      margin-bottom: 0;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #111;
      border: 1px solid #333;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #fff;
    }

    .checkbox-group span {
      font-size: 12px;
      color: #888;
    }

    /* Sales entries */
    .sales-entries {
      margin-top: 24px;
      border-top: 1px solid #333;
      padding-top: 24px;
    }

    .sales-entry {
      background: #0a0a0a;
      border: 1px solid #333;
      padding: 16px;
      margin-bottom: 12px;
    }

    /* Commission type toggle */
    .commission-type-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 12px;
    }

    .commission-type-btn {
      flex: 1;
      padding: 10px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #666;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .commission-type-btn:first-child {
      border-right: none;
    }

    .commission-type-btn.active {
      background: #ffffff;
      color: #000000;
      border-color: #ffffff;
    }

    .commission-calc-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .calculated-commission {
      background: #1a2a1a;
      border: 1px solid #2a4a2a;
      padding: 10px;
      text-align: center;
      margin-top: 8px;
    }

    .calculated-commission .label {
      font-size: 9px;
      color: #6bff6b;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .calculated-commission .value {
      font-size: 18px;
      color: #6bff6b;
      font-weight: 600;
    }

    /* Pay Period Summary */
    .pay-period-card {
      background: #111;
      border: 1px solid #333;
      margin-bottom: 20px;
    }

    .pay-period-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #333;
    }

    .pay-period-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pay-period-nav button {
      background: #222;
      border: 1px solid #444;
      color: #fff;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
    }

    .pay-period-nav button:hover {
      background: #333;
    }

    .pay-period-nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .pay-period-dates {
      font-size: 13px;
      color: #888;
      letter-spacing: 0.05em;
    }

    .pay-period-label {
      font-size: 10px;
      color: #666;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .pay-period-body {
      padding: 20px;
    }

    .pay-period-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .pay-stat {
      background: #0a0a0a;
      border: 1px solid #222;
      padding: 16px;
      text-align: center;
    }

    .pay-stat .label {
      font-size: 9px;
      color: #666;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .pay-stat .value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 24px;
      color: #fff;
    }

    .pay-stat.total {
      grid-column: span 2;
      background: #1a2a1a;
      border-color: #2a4a2a;
    }

    .pay-stat.total .value {
      color: #6bff6b;
      font-size: 32px;
    }

    .invoice-status {
      text-align: center;
      padding: 12px;
      font-size: 11px;
      letter-spacing: 0.1em;
    }

    .invoice-status.submitted {
      background: #1a2a1a;
      color: #6bff6b;
      border: 1px solid #2a4a2a;
    }

    .invoice-status.pending {
      background: #2a2a1a;
      color: #ffcc6b;
      border: 1px solid #4a4a2a;
    }

    /* Conflict Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #111111;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      border: 1px solid #333;
    }

    .modal-content h3 {
      margin-bottom: 16px;
      font-size: 20px;
      color: #ff6b6b;
    }

    .modal-content p {
      color: #999;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-actions button {
      flex: 1;
    }

    /* Invoice Preview Modal */
    .invoice-preview {
      max-height: 70vh;
      overflow-y: auto;
    }

    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 12px;
    }

    .invoice-table th,
    .invoice-table td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    .invoice-table th {
      background: #0a0a0a;
      color: #888;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .invoice-table td {
      color: #ccc;
    }

    .invoice-table tfoot td {
      font-weight: 600;
      border-top: 2px solid #333;
    }

    /* PIN Change Modal */
    .pin-change-form .form-group {
      margin-bottom: 16px;
    }

    /* Recent entries */
    .entries-list {
      margin-top: 24px;
    }

    .entry-item {
      background: #0a0a0a;
      border: 1px solid #222;
      padding: 16px;
      margin-bottom: 12px;
    }

    .entry-date {
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px;
      color: #fff;
      margin-bottom: 8px;
    }

    .entry-details {
      font-size: 12px;
      color: #888;
    }

    .entry-earnings {
      margin-top: 8px;
      font-size: 14px;
      color: #6bff6b;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 16px;
      }

      .card {
        padding: 20px;
      }

      .time-row {
        grid-template-columns: 1fr;
      }

      .time-row.three-col {
        grid-template-columns: 1fr 1fr;
      }

      .pay-period-stats {
        grid-template-columns: 1fr;
      }

      .pay-stat.total {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="screen active">
    <div class="login-box">
      <h2>LeMed Spa</h2>
      <p class="login-subtitle">PayTrack</p>
      <div class="alert error" id="login-error">Invalid PIN</div>
      <div class="form-group">
        <label for="pin-input">Enter Your PIN</label>
        <input type="password" id="pin-input" maxlength="4" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="4-digit PIN">
      </div>
      <button class="btn-primary" onclick="login()">Submit</button>
    </div>
  </div>

  <!-- Main App Screen -->
  <div id="main-screen" class="screen">
    <div class="header">
      <h1 id="employee-name">Employee</h1>
      <div class="header-actions">
        <button onclick="showPinChangeModal()">Change PIN</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('entry')" id="tab-entry-btn">Pay Entry</button>
      <button class="tab-btn" onclick="switchTab('review')" id="tab-review-btn">Pay Review</button>
    </div>

    <!-- PAY ENTRY TAB -->
    <div class="tab-content active" id="tab-entry">
      <div class="container">
        <!-- Time Entry Form -->
        <div class="card" id="time-entry-card">
          <h3>Daily Entry</h3>

          <!-- Date Picker -->
          <div class="date-picker-container">
            <div class="date-display">
              <div class="day-name" id="selected-day-name">Friday</div>
              <div class="full-date" id="selected-full-date">February 6th, 2026</div>
            </div>
            <div class="date-scroll-container">
              <button class="date-scroll-btn" onclick="scrollDate(-1)">&uarr;</button>
              <div class="date-wheel" id="date-wheel">
                <div class="date-wheel-inner" id="date-wheel-inner"></div>
              </div>
              <button class="date-scroll-btn" onclick="scrollDate(1)" id="date-scroll-down">&darr;</button>
            </div>
          </div>

          <!-- Time Inputs -->
          <div class="time-row">
            <div class="form-group">
              <label>Start Time</label>
              <input type="time" id="start-time" onchange="calculateHours()">
            </div>
            <div class="form-group">
              <label>End Time</label>
              <input type="time" id="end-time" onchange="calculateHours()">
            </div>
          </div>

          <div class="form-group">
            <label>Break Time (minutes)</label>
            <input type="number" id="break-minutes" value="0" min="0" step="5" onchange="calculateHours()">
          </div>

          <div class="calculated-hours">
            <div class="label">Hours Worked</div>
            <div class="value" id="calculated-hours">0.00</div>
          </div>

          <!-- Service Entries (for service commission workers) -->
          <div class="service-entries" id="service-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 14px;">Services & Tips</h3>
              <button class="btn-secondary btn-small" onclick="addServiceEntry()">+ Add Service</button>
            </div>
            <div id="service-entries-container"></div>
          </div>

          <!-- Sales Entries (for sales commission workers) -->
          <div class="sales-entries" id="sales-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 14px;">Sales</h3>
              <button class="btn-secondary btn-small" onclick="addSalesEntry()">+ Add Sale</button>
            </div>
            <div id="sales-entries-container"></div>
          </div>

          <div class="alert error" id="entry-error"></div>
          <div class="alert success" id="entry-success"></div>

          <button class="btn-primary" onclick="submitEntry()" id="submit-entry-btn">Save Entry</button>
        </div>
      </div>
    </div>

    <!-- PAY REVIEW TAB -->
    <div class="tab-content" id="tab-review">
      <div class="container wide">
        <!-- Pay Period Summary -->
        <div class="pay-period-card" id="pay-period-card">
          <div class="pay-period-header">
            <div class="pay-period-nav">
              <button onclick="changePeriod(-1)" id="prev-period-btn">&larr;</button>
              <div>
                <div class="pay-period-label">Pay Period</div>
                <div class="pay-period-dates" id="period-dates">Loading...</div>
              </div>
              <button onclick="changePeriod(1)" id="next-period-btn">&rarr;</button>
            </div>
          </div>
          <div class="pay-period-body">
            <div class="pay-period-stats">
              <div class="pay-stat">
                <div class="label">Hours Worked</div>
                <div class="value" id="period-hours">0.0</div>
              </div>
              <div class="pay-stat">
                <div class="label">Wages</div>
                <div class="value" id="period-wages">$0</div>
              </div>
              <div class="pay-stat">
                <div class="label">Commissions</div>
                <div class="value" id="period-commissions">$0</div>
              </div>
              <div class="pay-stat">
                <div class="label">Tips</div>
                <div class="value" id="period-tips">$0</div>
              </div>
              <div class="pay-stat total">
                <div class="label">Total Payable</div>
                <div class="value" id="period-total">$0</div>
              </div>
            </div>
            <div id="invoice-status"></div>
            <button class="btn-primary" id="submit-invoice-btn" onclick="showInvoicePreview()" style="margin-top: 12px;">Generate Invoice for Review</button>
          </div>
        </div>

        <!-- Daily Entries Breakdown -->
        <div class="card">
          <h3>Entries This Period</h3>
          <div style="overflow-x: auto; margin-top: 16px;">
            <table class="review-table" id="review-entries-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="right">Hours</th>
                  <th class="right">Wages</th>
                  <th class="right">Service Comm</th>
                  <th class="right">Sales Comm</th>
                  <th class="right">Tips</th>
                  <th class="right">Cash Tips</th>
                  <th class="right">Day Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="review-entries-body">
                <tr><td colspan="9" class="no-entries">Loading...</td></tr>
              </tbody>
              <tfoot id="review-entries-footer" style="display: none;">
                <tr>
                  <td><strong>TOTALS</strong></td>
                  <td class="right" id="review-total-hours">0.00</td>
                  <td class="right" id="review-total-wages">$0.00</td>
                  <td class="right" id="review-total-service">$0.00</td>
                  <td class="right" id="review-total-sales">$0.00</td>
                  <td class="right" id="review-total-tips">$0.00</td>
                  <td class="right cash-tips" id="review-total-cash">-$0.00</td>
                  <td class="right total-value" id="review-total-payable">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Conflict Modal -->
  <div id="conflict-modal" class="modal">
    <div class="modal-content">
      <h3>Entry Conflict</h3>
      <p id="conflict-message">An entry already exists for this date. Do you want to delete the existing entry and replace it with this new one?</p>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeConflictModal()">Cancel</button>
        <button class="btn-danger" onclick="overrideEntry()">Delete & Override</button>
      </div>
    </div>
  </div>

  <!-- Invoice Preview Modal -->
  <div id="invoice-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <h3 style="color: #fff;">Invoice Review</h3>
      <div class="invoice-preview" id="invoice-preview"></div>
      <p style="font-size: 12px; color: #888; margin: 16px 0;">This will send an invoice to lea@lemedspa.com and ops@lemedspa.com</p>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
        <button class="btn-success" onclick="submitInvoice()">Confirm & Submit</button>
      </div>
    </div>
  </div>

  <!-- PIN Change Modal -->
  <div id="pin-modal" class="modal">
    <div class="modal-content">
      <h3 style="color: #fff;">Change PIN</h3>
      <div class="pin-change-form">
        <div class="form-group">
          <label>Current PIN</label>
          <input type="password" id="current-pin" maxlength="4" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>New PIN</label>
          <input type="password" id="new-pin" maxlength="4" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>Confirm New PIN</label>
          <input type="password" id="confirm-pin" maxlength="4" inputmode="numeric">
        </div>
        <div class="alert error" id="pin-error"></div>
        <div class="alert success" id="pin-success"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closePinModal()">Cancel</button>
        <button class="btn-primary" onclick="changePin()">Change PIN</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentEmployee = null;
    let currentPin = '';
    let selectedDate = new Date();
    let periodOffset = 0;
    let currentPayPeriod = null;
    let conflictEntryId = null;
    let pendingEntry = null;
    let serviceCount = 0;
    let salesCount = 0;
    let currentTab = 'entry';

    // Get current date/time in Los Angeles timezone
    function getLADate() {
      const now = new Date();
      const laTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
      return laTime;
    }

    // Get today's date string in LA timezone (YYYY-MM-DD)
    function getLAToday() {
      const la = getLADate();
      return `${la.getFullYear()}-${String(la.getMonth() + 1).padStart(2, '0')}-${String(la.getDate()).padStart(2, '0')}`;
    }

    // Initialize
    document.getElementById('pin-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') login();
    });

    // Tab Switching
    function switchTab(tab) {
      currentTab = tab;

      // Update tab buttons
      document.getElementById('tab-entry-btn').classList.toggle('active', tab === 'entry');
      document.getElementById('tab-review-btn').classList.toggle('active', tab === 'review');

      // Update tab content
      document.getElementById('tab-entry').classList.toggle('active', tab === 'entry');
      document.getElementById('tab-review').classList.toggle('active', tab === 'review');

      // Load review data when switching to review tab
      if (tab === 'review') {
        loadPayPeriod();
        loadReviewEntries();
      }
    }

    // Check for saved session
    const savedEmployee = sessionStorage.getItem('employee');
    const savedPin = sessionStorage.getItem('pin');
    if (savedEmployee) {
      currentEmployee = JSON.parse(savedEmployee);
      currentPin = savedPin;
      showMainScreen();
    }

    // Login
    async function login() {
      const pin = document.getElementById('pin-input').value;
      const errorEl = document.getElementById('login-error');
      errorEl.classList.remove('show');

      try {
        const response = await fetch('/api/verify-pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pin })
        });

        const data = await response.json();

        if (data.success) {
          currentEmployee = data.employee;
          currentPin = pin;
          sessionStorage.setItem('employee', JSON.stringify(currentEmployee));
          sessionStorage.setItem('pin', pin);
          showMainScreen();
        } else {
          errorEl.classList.add('show');
          document.getElementById('pin-input').value = '';
        }
      } catch (error) {
        errorEl.textContent = 'Connection error';
        errorEl.classList.add('show');
      }
    }

    function logout() {
      currentEmployee = null;
      currentPin = '';
      sessionStorage.removeItem('employee');
      sessionStorage.removeItem('pin');
      document.getElementById('pin-input').value = '';
      document.getElementById('login-screen').classList.add('active');
      document.getElementById('main-screen').classList.remove('active');
    }

    function showMainScreen() {
      document.getElementById('login-screen').classList.remove('active');
      document.getElementById('main-screen').classList.add('active');
      document.getElementById('employee-name').textContent = currentEmployee.name;

      // Show/hide sections based on pay type
      const payType = currentEmployee.pay_type;

      // Determine what to show
      const showServices = ['commission_services', 'hourly_services', 'hourly_all'].includes(payType);
      const showSales = ['commission_sales', 'hourly_sales', 'hourly_all'].includes(payType);

      document.getElementById('service-section').style.display = showServices ? 'block' : 'none';
      document.getElementById('sales-section').style.display = showSales ? 'block' : 'none';

      // Reset to entry tab
      switchTab('entry');

      initializeDatePicker();
      loadPayPeriod();
    }

    // Load Review Entries for Pay Review Tab
    async function loadReviewEntries() {
      if (!currentPayPeriod) return;

      const tbody = document.getElementById('review-entries-body');
      const tfoot = document.getElementById('review-entries-footer');
      tbody.innerHTML = '<tr><td colspan="9" class="no-entries">Loading...</td></tr>';
      tfoot.style.display = 'none';

      try {
        const response = await fetch(`/api/invoice-preview/${currentEmployee.id}?periodStart=${currentPayPeriod.periodStart}&periodEnd=${currentPayPeriod.periodEnd}`);
        const data = await response.json();

        if (!data.entries || data.entries.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="no-entries">No entries for this pay period</td></tr>';
          return;
        }

        // Format date for display
        const formatDateShort = (dateStr) => {
          const d = new Date(dateStr + 'T00:00:00');
          const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          return `${days[d.getDay()]} ${d.getMonth() + 1}/${d.getDate()}`;
        };

        // Sort entries by date descending (most recent first)
        const sortedEntries = [...data.entries].sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        });

        // Build rows
        let rows = '';
        sortedEntries.forEach(entry => {
          const dayTotal = entry.wages + entry.commissions + entry.productCommissions + entry.tips - entry.cashTips;
          rows += `
            <tr>
              <td>${formatDateShort(entry.date)}</td>
              <td class="right">${entry.hours.toFixed(2)}</td>
              <td class="right">$${entry.wages.toFixed(2)}</td>
              <td class="right">$${entry.commissions.toFixed(2)}</td>
              <td class="right">$${entry.productCommissions.toFixed(2)}</td>
              <td class="right">$${entry.tips.toFixed(2)}</td>
              <td class="right cash-tips">${entry.cashTips > 0 ? '-$' + entry.cashTips.toFixed(2) : '-'}</td>
              <td class="right" style="font-weight: 600;">$${dayTotal.toFixed(2)}</td>
              <td class="right"><button class="btn-delete-small" onclick="deleteReviewEntry(${entry.id}, '${entry.date}')">Delete</button></td>
            </tr>
          `;
        });
        tbody.innerHTML = rows;

        // Update footer totals
        const s = data.summary;
        document.getElementById('review-total-hours').textContent = s.totalHours.toFixed(2);
        document.getElementById('review-total-wages').textContent = '$' + s.totalWages.toFixed(2);
        document.getElementById('review-total-service').textContent = '$' + s.totalCommissions.toFixed(2);
        document.getElementById('review-total-sales').textContent = '$' + s.totalProductCommissions.toFixed(2);
        document.getElementById('review-total-tips').textContent = '$' + s.totalTips.toFixed(2);
        document.getElementById('review-total-cash').textContent = '-$' + s.totalCashTips.toFixed(2);
        document.getElementById('review-total-payable').textContent = '$' + s.totalPayable.toFixed(2);
        tfoot.style.display = 'table-footer-group';

      } catch (error) {
        console.error('Error loading review entries:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="no-entries" style="color: #ff6b6b;">Error loading entries</td></tr>';
      }
    }

    // Date Picker
    function initializeDatePicker() {
      selectedDate = getLADate();
      selectedDate.setHours(0, 0, 0, 0);
      updateDateDisplay();
      buildDateWheel();
    }

    function updateDateDisplay() {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const dayName = days[selectedDate.getDay()];
      const month = months[selectedDate.getMonth()];
      const date = selectedDate.getDate();
      const year = selectedDate.getFullYear();

      const suffix = getOrdinalSuffix(date);

      document.getElementById('selected-day-name').textContent = dayName;
      document.getElementById('selected-full-date').textContent = `${month} ${date}${suffix}, ${year}`;
    }

    function getOrdinalSuffix(n) {
      const s = ['th', 'st', 'nd', 'rd'];
      const v = n % 100;
      return s[(v - 20) % 10] || s[v] || s[0];
    }

    function buildDateWheel() {
      const container = document.getElementById('date-wheel-inner');
      container.innerHTML = '';

      // Use LA timezone for "today"
      const today = getLADate();
      today.setHours(0, 0, 0, 0);

      // Show 30 days back and forward
      for (let i = -30; i <= 30; i++) {
        const date = new Date(selectedDate);
        date.setDate(selectedDate.getDate() + i);

        const item = document.createElement('div');
        item.className = 'date-wheel-item';

        if (date > today) {
          item.classList.add('future');
        }

        if (i === 0) {
          item.classList.add('selected');
        }

        const dayAbbr = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
        item.textContent = `${dayAbbr} ${date.getMonth() + 1}/${date.getDate()}`;
        item.dataset.offset = i;

        item.onclick = () => {
          if (date <= today) {
            selectDateByOffset(i);
          }
        };

        container.appendChild(item);
      }

      // Position to show selected in middle
      container.style.transform = `translateY(${-30 * 40 + 40}px)`;

      updateScrollButtons();
    }

    function scrollDate(direction) {
      // Use LA timezone for "today"
      const today = getLADate();
      today.setHours(0, 0, 0, 0);

      const newDate = new Date(selectedDate);
      newDate.setDate(newDate.getDate() + direction);

      if (newDate <= today) {
        selectedDate = newDate;
        updateDateDisplay();
        buildDateWheel();
      }
    }

    function selectDateByOffset(offset) {
      // Use LA timezone for "today"
      const today = getLADate();
      today.setHours(0, 0, 0, 0);

      const newDate = new Date(selectedDate);
      newDate.setDate(newDate.getDate() + offset);

      if (newDate <= today) {
        selectedDate = newDate;
        updateDateDisplay();
        buildDateWheel();
      }
    }

    function updateScrollButtons() {
      // Use LA timezone for "today"
      const today = getLADate();
      today.setHours(0, 0, 0, 0);

      const downBtn = document.getElementById('date-scroll-down');
      const nextDay = new Date(selectedDate);
      nextDay.setDate(nextDay.getDate() + 1);

      downBtn.disabled = nextDay > today;
    }

    // Time Calculation
    function calculateHours() {
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;
      const breakMinutes = parseInt(document.getElementById('break-minutes').value) || 0;

      if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        let end = new Date(`2000-01-01T${endTime}`);

        if (end < start) {
          end.setDate(end.getDate() + 1);
        }

        const diffMs = end - start;
        const diffHours = (diffMs / (1000 * 60 * 60)) - (breakMinutes / 60);
        const hours = Math.max(0, diffHours);

        document.getElementById('calculated-hours').textContent = hours.toFixed(2);
        return hours;
      }

      document.getElementById('calculated-hours').textContent = '0.00';
      return 0;
    }

    // Service Entries (renamed from Patient)
    function addServiceEntry() {
      serviceCount++;
      const container = document.getElementById('service-entries-container');

      const entry = document.createElement('div');
      entry.className = 'service-entry';
      entry.id = `service-${serviceCount}`;
      entry.innerHTML = `
        <div class="service-entry-header">
          <span class="service-entry-title">Service #${serviceCount}</span>
          <button class="remove-entry" onclick="removeServiceEntry(${serviceCount})">&times;</button>
        </div>
        <div class="form-group">
          <label>Service Description</label>
          <input type="text" class="service-client" placeholder="Service / client details">
        </div>
        <div class="form-group">
          <label>Procedure</label>
          <input type="text" class="service-name" placeholder="Procedure performed">
        </div>
        <div class="time-row">
          <div class="form-group">
            <label>Earnings ($)</label>
            <input type="number" class="service-earnings" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Tip ($)</label>
            <input type="number" class="service-tip" step="0.01" min="0" placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <input type="text" class="service-notes" placeholder="Optional notes">
        </div>
        <label class="checkbox-group">
          <input type="checkbox" class="tip-cash">
          <span>Tip received in cash (already paid out)</span>
        </label>
      `;

      container.appendChild(entry);
    }

    function removeServiceEntry(id) {
      const entry = document.getElementById(`service-${id}`);
      if (entry) entry.remove();
    }

    // Sales Entries with commission type toggle
    function addSalesEntry() {
      salesCount++;
      const container = document.getElementById('sales-entries-container');

      const entry = document.createElement('div');
      entry.className = 'sales-entry';
      entry.id = `sales-${salesCount}`;
      entry.innerHTML = `
        <div class="service-entry-header">
          <span class="service-entry-title">Sale #${salesCount}</span>
          <button class="remove-entry" onclick="removeSalesEntry(${salesCount})">&times;</button>
        </div>
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" class="product-name" placeholder="Product sold">
        </div>
        <div class="form-group">
          <label>Sale Amount ($)</label>
          <input type="number" class="product-amount" step="0.01" min="0" placeholder="0.00" oninput="calculateSalesCommission(${salesCount})">
        </div>
        <div class="form-group">
          <label>Commission Type</label>
          <div class="commission-type-toggle">
            <button type="button" class="commission-type-btn active" data-type="percent" onclick="setCommissionType(${salesCount}, 'percent')">% Percentage</button>
            <button type="button" class="commission-type-btn" data-type="flat" onclick="setCommissionType(${salesCount}, 'flat')">$ Flat Amount</button>
          </div>
        </div>
        <div class="commission-calc-row">
          <div class="form-group" id="commission-input-${salesCount}">
            <label>Commission Rate (%)</label>
            <input type="number" class="commission-rate" step="0.1" min="0" placeholder="10" oninput="calculateSalesCommission(${salesCount})">
          </div>
        </div>
        <div class="calculated-commission" id="calc-commission-${salesCount}">
          <div class="label">Commission Earned</div>
          <div class="value">$0.00</div>
        </div>
        <input type="hidden" class="commission-type" value="percent">
        <input type="hidden" class="product-commission" value="0">
        <div class="form-group" style="margin-top: 12px;">
          <label>Notes</label>
          <input type="text" class="product-notes" placeholder="Optional notes">
        </div>
      `;

      container.appendChild(entry);
    }

    function removeSalesEntry(id) {
      const entry = document.getElementById(`sales-${id}`);
      if (entry) entry.remove();
    }

    // Delete entry from Pay Review
    async function deleteReviewEntry(entryId, dateStr) {
      if (!confirm(`Are you sure you want to delete the entry for ${dateStr}?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/time-entry/${entryId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ employeeId: currentEmployee.id })
        });

        const data = await response.json();

        if (data.success) {
          // Reload the review data
          loadPayPeriod();
          loadReviewEntries();
        } else {
          alert('Failed to delete entry: ' + (data.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error deleting entry:', error);
        alert('Connection error while deleting entry');
      }
    }

    function setCommissionType(id, type) {
      const entry = document.getElementById(`sales-${id}`);
      if (!entry) return;

      // Update buttons
      entry.querySelectorAll('.commission-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });

      // Update hidden input
      entry.querySelector('.commission-type').value = type;

      // Update label
      const inputGroup = document.getElementById(`commission-input-${id}`);
      const label = inputGroup.querySelector('label');
      const input = inputGroup.querySelector('input');

      if (type === 'percent') {
        label.textContent = 'Commission Rate (%)';
        input.placeholder = '10';
      } else {
        label.textContent = 'Flat Commission ($)';
        input.placeholder = '0.00';
      }

      calculateSalesCommission(id);
    }

    function calculateSalesCommission(id) {
      const entry = document.getElementById(`sales-${id}`);
      if (!entry) return;

      const saleAmount = parseFloat(entry.querySelector('.product-amount').value) || 0;
      const commissionType = entry.querySelector('.commission-type').value;
      const rateInput = entry.querySelector('.commission-rate').value;
      const rate = parseFloat(rateInput) || 0;

      let commission = 0;
      if (commissionType === 'percent') {
        commission = saleAmount * (rate / 100);
      } else {
        commission = rate;
      }

      // Update display
      const calcDisplay = document.getElementById(`calc-commission-${id}`);
      calcDisplay.querySelector('.value').textContent = `$${commission.toFixed(2)}`;

      // Store value
      entry.querySelector('.product-commission').value = commission.toFixed(2);
    }

    // Check for conflicts
    async function checkConflict() {
      const dateStr = formatDate(selectedDate);

      try {
        const response = await fetch('/api/check-conflict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            employeeId: currentEmployee.id,
            date: dateStr
          })
        });

        return await response.json();
      } catch (error) {
        console.error('Error checking conflict:', error);
        return { hasConflict: false };
      }
    }

    // Submit Entry
    async function submitEntry() {
      const hours = calculateHours();

      if (hours <= 0) {
        showError('entry-error', 'Please enter valid start and end times');
        return;
      }

      // Check for conflict
      const conflict = await checkConflict();

      if (conflict.hasConflict) {
        conflictEntryId = conflict.existingEntry.id;
        pendingEntry = gatherEntryData(hours);

        const existingHours = conflict.existingEntry.hours;
        const existingTime = conflict.existingEntry.start_time && conflict.existingEntry.end_time
          ? `${formatTime12(conflict.existingEntry.start_time)} - ${formatTime12(conflict.existingEntry.end_time)}`
          : `${existingHours} hours`;

        document.getElementById('conflict-message').innerHTML = `
          <strong>An entry already exists for ${formatDateDisplay(selectedDate)}:</strong><br><br>
          Existing entry: ${existingTime} (${existingHours.toFixed(2)} hours)<br><br>
          Do you want to <strong>delete the existing entry</strong> and replace it with your new entry?
        `;

        document.getElementById('conflict-modal').classList.add('show');
        return;
      }

      // No conflict, submit directly
      await saveEntry(gatherEntryData(hours));
    }

    function gatherEntryData(hours) {
      const clients = [];
      document.querySelectorAll('.service-entry').forEach(entry => {
        const name = entry.querySelector('.service-client').value.trim();
        const earnings = parseFloat(entry.querySelector('.service-earnings').value) || 0;
        const tip = parseFloat(entry.querySelector('.service-tip').value) || 0;
        // Include if there's a name OR any earnings/tips
        if (name || earnings > 0 || tip > 0) {
          clients.push({
            clientName: name || 'Service',
            procedure: entry.querySelector('.service-name').value.trim(),
            notes: entry.querySelector('.service-notes').value.trim(),
            amountEarned: earnings,
            tipAmount: tip,
            tipReceivedCash: entry.querySelector('.tip-cash').checked
          });
        }
      });

      const productSales = [];
      document.querySelectorAll('.sales-entry').forEach(entry => {
        const name = entry.querySelector('.product-name').value.trim();
        const amount = parseFloat(entry.querySelector('.product-amount').value) || 0;
        const commission = parseFloat(entry.querySelector('.product-commission').value) || 0;
        // Include if there's a name OR any sale amount/commission
        if (name || amount > 0 || commission > 0) {
          productSales.push({
            productName: name || 'Sale',
            saleAmount: amount,
            commissionAmount: commission,
            notes: entry.querySelector('.product-notes').value.trim()
          });
        }
      });

      return {
        employeeId: currentEmployee.id,
        date: formatDate(selectedDate),
        startTime: document.getElementById('start-time').value,
        endTime: document.getElementById('end-time').value,
        breakMinutes: parseInt(document.getElementById('break-minutes').value) || 0,
        hours,
        clients,
        productSales
      };
    }

    async function overrideEntry() {
      closeConflictModal();

      // Delete existing entry
      try {
        await fetch(`/api/time-entry/${conflictEntryId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ employeeId: currentEmployee.id })
        });
      } catch (error) {
        console.error('Error deleting entry:', error);
      }

      // Save new entry
      await saveEntry(pendingEntry);

      conflictEntryId = null;
      pendingEntry = null;
    }

    async function saveEntry(entryData) {
      try {
        const response = await fetch('/api/time-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entryData)
        });

        const data = await response.json();

        if (data.success) {
          showSuccess('entry-success', 'Entry saved successfully!');
          clearForm();
          loadPayPeriod();
          // Also update review tab data if it's been loaded
          if (currentTab === 'review') {
            loadReviewEntries();
          }
        } else {
          showError('entry-error', data.message || 'Failed to save entry');
        }
      } catch (error) {
        showError('entry-error', 'Connection error');
      }
    }

    function closeConflictModal() {
      document.getElementById('conflict-modal').classList.remove('show');
    }

    function clearForm() {
      document.getElementById('start-time').value = '';
      document.getElementById('end-time').value = '';
      document.getElementById('break-minutes').value = '0';
      document.getElementById('calculated-hours').textContent = '0.00';
      document.getElementById('service-entries-container').innerHTML = '';
      document.getElementById('sales-entries-container').innerHTML = '';
      serviceCount = 0;
      salesCount = 0;
    }

    // Pay Period
    async function loadPayPeriod() {
      try {
        const response = await fetch(`/api/pay-period/${currentEmployee.id}?offset=${periodOffset}`);
        currentPayPeriod = await response.json();

        updatePayPeriodDisplay();

        // If on review tab, also load review entries
        if (currentTab === 'review') {
          loadReviewEntries();
        }
      } catch (error) {
        console.error('Error loading pay period:', error);
      }
    }

    function updatePayPeriodDisplay() {
      if (!currentPayPeriod) return;

      const startDate = new Date(currentPayPeriod.periodStart + 'T00:00:00');
      const endDate = new Date(currentPayPeriod.periodEnd + 'T00:00:00');

      const formatPeriodDate = (d) => {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[d.getMonth()]} ${d.getDate()}`;
      };

      document.getElementById('period-dates').textContent =
        `${formatPeriodDate(startDate)} - ${formatPeriodDate(endDate)}, ${endDate.getFullYear()}`;

      document.getElementById('period-hours').textContent = currentPayPeriod.totalHours.toFixed(1);
      document.getElementById('period-wages').textContent = `$${currentPayPeriod.totalWages.toFixed(0)}`;
      document.getElementById('period-commissions').textContent = `$${(currentPayPeriod.totalCommissions + currentPayPeriod.totalProductCommissions).toFixed(0)}`;
      document.getElementById('period-tips').textContent = `$${currentPayPeriod.totalTips.toFixed(0)}`;
      document.getElementById('period-total').textContent = `$${currentPayPeriod.totalPayable.toFixed(2)}`;

      // Invoice status
      const statusEl = document.getElementById('invoice-status');
      const submitBtn = document.getElementById('submit-invoice-btn');

      if (currentPayPeriod.invoiceSubmitted) {
        statusEl.className = 'invoice-status submitted';
        statusEl.textContent = `Invoice submitted on ${new Date(currentPayPeriod.invoiceDate).toLocaleDateString()}`;
        submitBtn.style.display = 'none';
      } else if (periodOffset > 0) {
        statusEl.className = 'invoice-status';
        statusEl.textContent = '';
        submitBtn.style.display = 'none';
      } else {
        statusEl.className = 'invoice-status pending';
        statusEl.textContent = 'Invoice not yet submitted';
        submitBtn.style.display = 'block';
      }

      // Disable forward button if at current period
      document.getElementById('next-period-btn').disabled = periodOffset >= 0;
    }

    function changePeriod(direction) {
      // Don't allow going to future periods
      if (direction > 0 && periodOffset >= 0) return;

      periodOffset += direction;
      loadPayPeriod();
    }

    // Invoice
    async function showInvoicePreview() {
      if (!currentPayPeriod || currentPayPeriod.invoiceSubmitted) return;

      const preview = document.getElementById('invoice-preview');
      preview.innerHTML = '<p style="text-align: center; padding: 20px;">Loading...</p>';
      document.getElementById('invoice-modal').classList.add('show');

      try {
        // Fetch detailed invoice data
        const response = await fetch(`/api/invoice-preview/${currentEmployee.id}?periodStart=${currentPayPeriod.periodStart}&periodEnd=${currentPayPeriod.periodEnd}`);
        const data = await response.json();

        if (!data.entries || data.entries.length === 0) {
          preview.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">No entries for this pay period</p>';
          return;
        }

        // Format date for display
        const formatDateShort = (dateStr) => {
          const d = new Date(dateStr + 'T00:00:00');
          const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          return `${days[d.getDay()]} ${d.getMonth() + 1}/${d.getDate()}`;
        };

        // Build daily rows
        let dailyRows = '';
        data.entries.forEach(entry => {
          const dayTotal = entry.wages + entry.commissions + entry.productCommissions + entry.tips - entry.cashTips;
          dailyRows += `
            <tr>
              <td>${formatDateShort(entry.date)}</td>
              <td style="text-align: right;">${entry.hours.toFixed(2)}</td>
              <td style="text-align: right;">$${entry.wages.toFixed(2)}</td>
              <td style="text-align: right;">$${entry.commissions.toFixed(2)}</td>
              <td style="text-align: right;">$${entry.productCommissions.toFixed(2)}</td>
              <td style="text-align: right;">$${entry.tips.toFixed(2)}</td>
              <td style="text-align: right; color: #ff6b6b;">${entry.cashTips > 0 ? '-$' + entry.cashTips.toFixed(2) : '-'}</td>
              <td style="text-align: right; font-weight: 600;">$${dayTotal.toFixed(2)}</td>
            </tr>
          `;
        });

        const summary = data.summary;

        preview.innerHTML = `
          <p style="font-size: 11px; color: #888; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em;">
            Pay Period: ${currentPayPeriod.periodStart} to ${currentPayPeriod.periodEnd}
          </p>
          <p style="font-size: 12px; color: #aaa; margin-bottom: 16px;">
            Hourly Rate: $${data.employee.hourlyWage}/hr
          </p>
          <div style="overflow-x: auto;">
            <table class="invoice-table" style="min-width: 600px;">
              <thead>
                <tr>
                  <th>Date</th>
                  <th style="text-align: right;">Hours</th>
                  <th style="text-align: right;">Wages</th>
                  <th style="text-align: right;">Service Comm</th>
                  <th style="text-align: right;">Sales Comm</th>
                  <th style="text-align: right;">Tips</th>
                  <th style="text-align: right;">Cash Tips</th>
                  <th style="text-align: right;">Day Total</th>
                </tr>
              </thead>
              <tbody>
                ${dailyRows}
              </tbody>
              <tfoot>
                <tr style="background: #1a1a1a;">
                  <td><strong>TOTALS</strong></td>
                  <td style="text-align: right;"><strong>${summary.totalHours.toFixed(2)}</strong></td>
                  <td style="text-align: right;"><strong>$${summary.totalWages.toFixed(2)}</strong></td>
                  <td style="text-align: right;"><strong>$${summary.totalCommissions.toFixed(2)}</strong></td>
                  <td style="text-align: right;"><strong>$${summary.totalProductCommissions.toFixed(2)}</strong></td>
                  <td style="text-align: right;"><strong>$${summary.totalTips.toFixed(2)}</strong></td>
                  <td style="text-align: right; color: #ff6b6b;"><strong>-$${summary.totalCashTips.toFixed(2)}</strong></td>
                  <td style="text-align: right; color: #6bff6b; font-size: 14px;"><strong>$${summary.totalPayable.toFixed(2)}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Error loading invoice preview:', error);
        preview.innerHTML = '<p style="text-align: center; padding: 20px; color: #ff6b6b;">Error loading invoice details</p>';
      }
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('show');
    }

    async function submitInvoice() {
      if (!currentPayPeriod) return;

      try {
        const response = await fetch('/api/submit-invoice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            employeeId: currentEmployee.id,
            periodStart: currentPayPeriod.periodStart,
            periodEnd: currentPayPeriod.periodEnd,
            totalHours: currentPayPeriod.totalHours,
            totalWages: currentPayPeriod.totalWages,
            totalCommissions: currentPayPeriod.totalCommissions,
            totalTips: currentPayPeriod.totalTips,
            totalCashTips: currentPayPeriod.totalCashTips,
            totalProductCommissions: currentPayPeriod.totalProductCommissions,
            totalPayable: currentPayPeriod.totalPayable
          })
        });

        const data = await response.json();

        if (data.success) {
          closeInvoiceModal();
          loadPayPeriod();
          alert('Invoice submitted successfully! An email has been sent.');
        } else {
          alert(data.message || 'Failed to submit invoice');
        }
      } catch (error) {
        alert('Connection error');
      }
    }

    // PIN Change
    function showPinChangeModal() {
      document.getElementById('current-pin').value = '';
      document.getElementById('new-pin').value = '';
      document.getElementById('confirm-pin').value = '';
      document.getElementById('pin-error').classList.remove('show');
      document.getElementById('pin-success').classList.remove('show');
      document.getElementById('pin-modal').classList.add('show');
    }

    function closePinModal() {
      document.getElementById('pin-modal').classList.remove('show');
    }

    async function changePin() {
      const currentPinVal = document.getElementById('current-pin').value;
      const newPinVal = document.getElementById('new-pin').value;
      const confirmPinVal = document.getElementById('confirm-pin').value;

      if (!/^\d{4}$/.test(newPinVal)) {
        showError('pin-error', 'New PIN must be exactly 4 digits');
        return;
      }

      if (newPinVal !== confirmPinVal) {
        showError('pin-error', 'New PINs do not match');
        return;
      }

      try {
        const response = await fetch('/api/change-pin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            employeeId: currentEmployee.id,
            currentPin: currentPinVal,
            newPin: newPinVal
          })
        });

        const data = await response.json();

        if (data.success) {
          currentPin = newPinVal;
          sessionStorage.setItem('pin', newPinVal);
          showSuccess('pin-success', 'PIN changed successfully!');
          setTimeout(closePinModal, 1500);
        } else {
          showError('pin-error', data.message || 'Failed to change PIN');
        }
      } catch (error) {
        showError('pin-error', 'Connection error');
      }
    }

    // Load Entries
    async function loadEntries() {
      try {
        const response = await fetch(`/api/time-entries/${currentEmployee.id}`);
        const entries = await response.json();

        const container = document.getElementById('entries-list');

        if (entries.length === 0) {
          container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No entries yet</p>';
          return;
        }

        container.innerHTML = entries.slice(0, 10).map(entry => {
          const date = new Date(entry.date + 'T00:00:00');
          const dateStr = formatDateDisplay(date);

          const timeStr = entry.start_time && entry.end_time
            ? `${formatTime12(entry.start_time)} - ${formatTime12(entry.end_time)}`
            : `${entry.hours.toFixed(1)} hours`;

          let totalEarnings = entry.hours * (currentEmployee.hourly_wage || 0);

          if (entry.clients) {
            entry.clients.forEach(c => {
              totalEarnings += (c.amount_earned || 0) + (c.tip_amount || 0);
            });
          }

          if (entry.productSales) {
            entry.productSales.forEach(p => {
              totalEarnings += p.commission_amount || 0;
            });
          }

          return `
            <div class="entry-item">
              <div class="entry-date">${dateStr}</div>
              <div class="entry-details">${timeStr} (${entry.hours.toFixed(2)} hours)</div>
              ${totalEarnings > 0 ? `<div class="entry-earnings">$${totalEarnings.toFixed(2)}</div>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading entries:', error);
      }
    }

    // Utility Functions
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function formatDateDisplay(date) {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      const dayName = days[date.getDay()];
      const month = months[date.getMonth()];
      const day = date.getDate();
      const suffix = getOrdinalSuffix(day);

      return `${dayName}, ${month} ${day}${suffix}`;
    }

    function formatTime12(timeStr) {
      if (!timeStr) return '';
      const [hours, minutes] = timeStr.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }

    function showError(id, message) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }

    function showSuccess(id, message) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed'));
    }
  </script>
</body>
</html>
